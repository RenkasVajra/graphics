# Лабораторная работа 8: Алгоритм обратной трассировки лучей

## Описание

Программа реализует полнофункциональный алгоритм обратной трассировки лучей (ray tracing) с поддержкой отражений, преломлений, теней и различных типов объектов. Включает графический интерфейс для интерактивного управления параметрами материалов объектов.

## Основные классы

### Класс `Light`
**Назначение:** Представляет источник света в сцене.

**Параметры:**
- `position` (array) - позиция источника света в 3D пространстве
- `intensity` (float) - интенсивность света (по умолчанию 1.0)
- `color` (tuple) - цвет света в формате RGB (по умолчанию белый)

**Использование:**
```python
light = Light([5.0, 5.0, 5.0], intensity=1.0, color=[1.0, 1.0, 1.0])
```

### Класс `SceneObject` (базовый)
**Назначение:** Базовый класс для всех объектов сцены.

**Параметры материала:**
- `color` (array) - базовый цвет объекта (RGB)
- `ambient` (float) - коэффициент фонового освещения (0-1)
- `diffuse` (float) - коэффициент диффузного отражения (0-1)
- `specular` (float) - коэффициент зеркального отражения (0-1)
- `shininess` (float) - коэффициент блеска для модели Фонга
- `reflective` (float) - коэффициент отражения (0-1)
- `transparent` (float) - коэффициент прозрачности (0-1)
- `refractive_index` (float) - коэффициент преломления (1.0 = воздух, 1.5 = стекло)

**Абстрактные методы:**
- `intersect(ray_origin, ray_direction)` - вычисляет пересечение луча с объектом
- `get_normal(point)` - возвращает нормаль в точке пересечения

### Класс `Sphere` (наследуется от `SceneObject`)
**Назначение:** Представляет сферу в сцене.

**Дополнительные параметры:**
- `center` (array) - центр сферы
- `radius` (float) - радиус сферы

**Метод `intersect()`:**
- Решает квадратное уравнение для пересечения луча со сферой
- Использует формулу: `(ray_origin - center)² = radius²`
- Возвращает ближайшее положительное пересечение или `None`

**Метод `get_normal()`:**
- Вычисляет нормализованный вектор от центра к точке пересечения

### Класс `Plane` (наследуется от `SceneObject`)
**Назначение:** Представляет бесконечную плоскость.

**Дополнительные параметры:**
- `point` (array) - точка на плоскости
- `normal` (array) - нормаль к плоскости (автоматически нормализуется)

**Метод `intersect()`:**
- Использует уравнение плоскости для нахождения пересечения
- Проверяет, что луч не параллелен плоскости
- Возвращает расстояние до пересечения или `None`

**Метод `get_normal()`:**
- Возвращает нормализованную нормаль плоскости

## Основные функции

### `reflect(incident, normal)`
**Назначение:** Вычисляет отраженный вектор по закону отражения.

**Формула:** `R = I - 2 * (I · N) * N`

**Параметры:**
- `incident` (array) - падающий вектор
- `normal` (array) - нормаль к поверхности

**Возвращает:** Отраженный вектор

### `refract(incident, normal, n1, n2)`
**Назначение:** Вычисляет преломленный вектор по закону Снеллиуса.

**Параметры:**
- `incident` (array) - падающий вектор
- `normal` (array) - нормаль к поверхности
- `n1` (float) - коэффициент преломления первой среды
- `n2` (float) - коэффициент преломления второй среды

**Алгоритм:**
1. Вычисляет косинус угла падения
2. Определяет, с какой стороны луч падает на поверхность
3. Применяет закон Снеллиуса: `n1 * sin(θ1) = n2 * sin(θ2)`
4. Проверяет на полное внутреннее отражение
5. Возвращает преломленный вектор или `None` при полном отражении

### `trace_ray(ray_origin, ray_direction, objects, lights, depth=0, n1=1.0)`
**Назначение:** Рекурсивная функция трассировки луча - сердце алгоритма.

**Параметры:**
- `ray_origin` (array) - начало луча
- `ray_direction` (array) - направление луча (нормализованное)
- `objects` (list) - список объектов сцены
- `lights` (list) - список источников света
- `depth` (int) - текущая глубина рекурсии
- `n1` (float) - коэффициент преломления текущей среды

**Алгоритм:**
1. **Проверка глубины рекурсии:** Если превышен `MAX_DEPTH`, возвращает черный цвет
2. **Поиск пересечений:** Находит ближайший объект, пересекаемый лучом
3. **Фон:** Если пересечений нет, возвращает градиент неба
4. **Вычисление точки пересечения и нормали**
5. **Фоновое освещение:** Добавляет ambient компонент
6. **Обработка источников света:**
   - Для каждого источника проверяет тени (shadow rays)
   - Вычисляет диффузное освещение (модель Ламберта)
   - Вычисляет зеркальное освещение (модель Фонга)
7. **Рекурсивные отражения:** Если объект отражающий, трассирует отраженный луч
8. **Рекурсивные преломления:** Если объект прозрачный, трассирует преломленный луч
9. **Возврат финального цвета:** Комбинирует все компоненты освещения

**Особенности:**
- Рекурсивная природа позволяет реалистичные отражения и преломления
- Ограничение глубины предотвращает бесконечную рекурсию
- Учет теней через shadow rays

### `render_scene(width, height)`
**Назначение:** Рендерит всю сцену в массив пикселей.

**Параметры:**
- `width` (int) - ширина изображения
- `height` (int) - высота изображения

**Алгоритм:**
1. Создает массив для хранения изображения
2. Для каждого пикселя:
   - Преобразует координаты пикселя в направление луча
   - Учитывает перспективную проекцию (FOV = 45°)
   - Вызывает `trace_ray()` для получения цвета
   - Сохраняет цвет в массив
3. Возвращает готовое изображение

**Камера:**
- Позиция: (0, 0, 5)
- Направление: в сторону отрицательной оси Z
- Поле зрения: 45 градусов

## Класс `RayTracingApp`

### Методы класса

#### `__init__(self, root)`
**Назначение:** Инициализация приложения и создание интерфейса.

#### `init_scene(self)`
**Назначение:** Создает сцену по умолчанию.

**Объекты сцены:**
1. **Красная отражающая сфера:**
   - Позиция: (-1.5, 0.0, -3.0)
   - Радиус: 0.8
   - Отражение: 0.5

2. **Зеленая прозрачная сфера:**
   - Позиция: (1.5, 0.0, -3.0)
   - Радиус: 0.8
   - Прозрачность: 0.8
   - Преломление: 1.5 (стекло)

3. **Синяя сфера:**
   - Позиция: (0.0, -1.5, -4.0)
   - Радиус: 0.6
   - Отражение: 0.3

4. **Пол (плоскость):**
   - Позиция: (0.0, -2.0, 0.0)
   - Нормаль: (0.0, 1.0, 0.0)
   - Цвет: серый

**Источники света:**
- Основной: (5.0, 5.0, 5.0), интенсивность 1.0
- Дополнительный: (-5.0, 3.0, -5.0), интенсивность 0.5

#### `create_ui(self)`
**Назначение:** Создает графический интерфейс управления.

**Компоненты:**
- Область отображения изображения
- Выпадающий список для выбора объекта
- Слайдеры для управления параметрами:
  - Отражение (0.0 - 1.0)
  - Прозрачность (0.0 - 1.0)
  - Преломление (1.0 - 2.5)
  - Диффузное освещение (0.0 - 1.0)
  - Зеркальное освещение (0.0 - 1.0)
  - Блеск (1.0 - 200.0)
- Кнопка "Перерисовать сцену"

#### `create_slider(self, label_text, variable, from_, to, command)`
**Назначение:** Создает слайдер с меткой и отображением значения.

#### `on_object_change(self, event=None)`
**Назначение:** Обновляет слайдеры при смене выбранного объекта.

#### `update_object(self, event=None)`
**Назначение:** Применяет значения слайдеров к выбранному объекту.

#### `render_image(self)`
**Назначение:** Запускает рендеринг в отдельном потоке.

**Особенности:**
- Рендеринг выполняется асинхронно для сохранения отзывчивости интерфейса
- Отображает время рендеринга после завершения

#### `update_image(self, pil_image, elapsed_time)`
**Назначение:** Обновляет изображение в интерфейсе после рендеринга.

## Как запустить

1. Установите зависимости:
   ```bash
   pip install numpy pillow tkinter
   ```
2. Запустите программу:
   ```bash
   python lab8.py
   ```

## Зависимости

- `numpy` - для математических операций с массивами
- `PIL` (Pillow) - для работы с изображениями
- `tkinter` - для графического интерфейса
- `threading` - для асинхронного рендеринга
- `time` - для измерения времени рендеринга

## Использование

1. При запуске программа автоматически рендерит сцену
2. Выберите объект из выпадающего списка
3. Измените параметры с помощью слайдеров
4. Нажмите "Перерисовать сцену" для применения изменений
5. Дождитесь завершения рендеринга (время отображается в интерфейсе)

## Особенности реализации

### Алгоритм трассировки лучей
- **Обратная трассировка:** Лучи идут от камеры к объектам
- **Рекурсивность:** Поддержка множественных отражений и преломлений
- **Реалистичное освещение:** Модель Фонга для зеркальных бликов
- **Тени:** Shadow rays для определения затененных областей

### Математические модели
- **Закон отражения:** Векторная формула отражения
- **Закон Снеллиуса:** Физически корректное преломление
- **Модель Фонга:** Реалистичные зеркальные блики
- **Модель Ламберта:** Диффузное отражение

### Производительность
- Рендеринг в отдельном потоке
- Оптимизация через numpy массивы
- Ограничение глубины рекурсии для предотвращения зависаний

## Параметры сцены

### Глобальные константы
- `WIDTH = 600` - ширина изображения
- `HEIGHT = 600` - высота изображения
- `MAX_DEPTH = 5` - максимальная глубина рекурсии

### Камера
- Позиция: (0, 0, 5)
- Направление: в сторону -Z
- FOV: 45 градусов

## Возможные улучшения

- Добавление других типов объектов (кубы, торы, треугольники)
- Поддержка текстур
- Антиалиасинг (суперсэмплинг)
- Оптимизация через пространственные структуры данных (BVH, kd-tree)
- Поддержка анимации
- Экспорт изображений

